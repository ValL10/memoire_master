{% extends 'core/base.html' %}

{% block title %}
    Listes des Réponses
{% endblock %}

{% block navbar %}
    {% include 'core/navbar.html' %}
{% endblock %}

{% block content %}

<section class="container">
    <h5 class="mt-2 mb-2"> Resultats de l'exercice </h5>
    <div class="row d-flex">
        <div class="col-6">
            <canvas class="card" id="barChart" style="height: 100%, width: 100%"></canvas>
        </div>
        <div class="col-6">
            <div class="card jumbotron m-1 p-1 shadow-sm">
                <div class="accordion accordion-flush" id="accordionFlushExample">
                    <div class="accordion-item">
                      <h2 class="accordion-header">
                        <div class="accordion-button collapsed p-2" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                            <div>
                                <h5 class="p-2">
                                    {{ exercice.titre_exercice }}
                                </h5>
                            </div>
                        </div>
                      </h2>
                      <div id="flush-collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionFlushExample">
                        <div class="accordion-body">
                            <div>
                                <h6 class="p-2">
                                    <span class="badge bg-light text-dark"><i class="fa fa-user-tag"></i> {{ exercice.created_at }}</span>
                                    <span class="badge bg-dark"><i class="fa fa-user-tag"></i> {{ exercice.parcours_cible }} </span>
                                    <span class="badge bg-dark"><i class="fa fa-tag"></i> {{ exercice.niveau_cible }} </span>
                                    <span class="badge bg-success"><i class="fab fa-python"></i> {{ exercice.langage_exercice }} </span>
                                    <span class="badge 
                                    {% if exercice.complexite_exercice == 1 %}
                                        bg-info text-dark
                                    {% elif exercice.complexite_exercice == 2 %}
                                        bg-primary text-white
                                    {% elif exercice.complexite_exercice == 3 %}
                                        bg-success text-white
                                    {% elif exercice.complexite_exercice == 4 %}
                                        bg-warning text-dark
                                    {% else %}
                                        bg-danger text-white
                                    {%endif%}
                                    ">
                                        <i class="fas fa-layer-group"></i> Compléxité: {{ exercice.complexite_exercice }}
                                    </span>
                                </h6>
                            </div>
                            <div class="m-2">
                                <p class="lead"> {{ exercice.description_exercice }} </p>
                            </div>
                        </div>
                      </div>
                    </div>
                </div>
            </div>
        </div>
    </div> 
    
    <div class="row mt-2">
        <div class="col-6">
            <div class="d-flex justify-content-between align-items-center mt-1">
                <h5>{{ count }} réponse(s): </h5>
                <input type="hidden" value="{{ count }}" id="count">
                <div class="text-end">
                    <a href="{% url 'export_responses' exercice.id %}" class="btn btn-sm btn-success">
                        <i class="fas fa-file-excel"></i> Exporter en XLSX
                    </a>
                </div>
            </div>
            <div class="card p-1 shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th></th>
                                <th>NIE</th>
                                <th>Nom</th>
                                <th>Note</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tbody">
                        {% for index,reponse in responses.items %}
                            <tr>
                                <td></td>
                                <td> {{ reponse.etudiant.profile.ni_etudiant }} </td>
                                <td> {{ reponse.etudiant.get_full_name }} </td>
                                <td> {{ reponse.note.note_numerique }}
                                    <input type="hidden" value="{{ reponse.id }}" id="reponse_{{ index }}">
                                </td>
                                <td>
                                    <button type="button" id="row_{{ index }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-code"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-6">
            <div class="card p-1 shadow-sm">
                <div class="m-1">
                    <h6 class="m-1"><i class="fas fa-code"></i>Code soumis</h6>
                </div>
                <textarea id="code-editor" name="codeValue" class="form-control codemirror m-1" rows="40"></textarea>
            </div>
        </div>
    </div>
</section>
{% load static %}
<script src="{% static "core/assets/js/chart.min.js" %}"></script>
<script src= {% static "core/assets/js/jquery.min.js" %}></script>
<script>

    function changeCodeAreaContent(){
        $(document).ready(function() {

            let monCodeMirror = CodeMirror.fromTextArea(document.getElementById("code-editor"),
                {
                        mode: "python",
                        theme: "dracula", // Vous pouvez choisir un thème parmi ceux disponibles
                        lineNumbers: true, // Pour afficher les numéros de ligne (facultatif)
                        indentUnit: 4,
                        readOnly: true
                });
    
            let count = $('#count').val()
    
            for(let i=0; i<count; i++){

                let reponse_id = $('#reponse_'+i).val()
    
                // Sélectionnez toutes les lignes du tableau
                $('#row_'+i).on('click', function() {
                    // Récupérez le texte de la ligne cliquée
                    let textligne = ajaxCall(reponse_id, monCodeMirror)
                    console.log(textligne)
                    
                });
            }

            function ajaxCall(reponse_id, monCodeMirror){
                let urlReponse = "{% url 'getResponseValue' 0 %}";
                urlReponse = urlReponse.replace('0', reponse_id);
                $.ajax({
                    url: urlReponse,  // Remplacez par l'URL de votre vue Django
                    type: "GET",
                    dataType: "json",
                    success: function(res) {
                        monCodeMirror.setValue(res[0].contenu_reponse);
                        monCodeMirror.setOption("readOnly", true);
                    },
                    error: function(xhr, textStatus, errorThrown) {
                        console.log("Erreur lors de la requête AJAX : " + errorThrown);
                    }
                });

                return "LOADED"
            }
    
        });
    }

    changeCodeAreaContent() 
</script>

<script>
    function chart3(){

        var labels = {{ NotesEtudiants.0|safe }}
        var data = {{ NotesEtudiants.1|safe }}

        var ctx = document.getElementById("barChart").getContext('2d');

        var barChart = new Chart(ctx, {
            type: 'bar', // Type de graphique en barres
            data: {
                labels: labels,
                datasets: [{
                    label: 'Resultat de l\'exercice',
                    data: data,
                    backgroundColor: 'rgba(75, 192, 192, 0.8)', // Couleur de remplissage des barres
                    borderColor: 'rgba(75, 192, 192, 1)', // Couleur de la bordure des barres
                    borderWidth: 1 // Largeur de la bordure
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true // Commencer l'axe y à zéro
                    }
                }
            }
        });


    }

    chart3()
</script>
{% endblock %}